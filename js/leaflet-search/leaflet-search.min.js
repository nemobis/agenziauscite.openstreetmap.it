/* 
 * Leaflet Control Search v1.5.2 - 2014-06-23 
 * 
 * Copyright 2014 Stefano Cudini 
 * stefano.cudini@gmail.com 
 * http://labs.easyblog.it/ 
 * 
 * Licensed under the MIT license. 
 * 
 * Demo: 
 * http://labs.easyblog.it/maps/leaflet-search/ 
 * 
 * Source: 
 * git@github.com:stefanocudini/leaflet-search.git 
 * 
 */(function(){L.Control.Search=L.Control.extend({includes:L.Mixin.Events,options:{wrapper:"",url:"",jsonpParam:null,layer:null,callData:null,propertyName:"title",propertyLoc:"loc",callTip:null,filterJSON:null,minLength:1,initial:!0,autoType:!0,delayType:400,tooltipLimit:-1,tipAutoSubmit:!0,autoResize:!0,collapsed:!0,autoCollapse:!1,autoCollapseTime:1200,animateLocation:!0,circleLocation:!0,markerLocation:!1,zoom:null,text:"Search...",textCancel:"Cancel",textErr:"Location not found",position:"topleft"},initialize:function(e){L.Util.setOptions(this,e||{}),this._inputMinSize=this.options.text?this.options.text.length:10,this._layer=this.options.layer||new L.LayerGroup,this._filterJSON=this.options.filterJSON||this._defaultFilterJSON,this._autoTypeTmp=this.options.autoType,this._countertips=0,this._recordsCache={}},onAdd:function(e){this._map=e,this._container=L.DomUtil.create("div","leaflet-control-search"),this._input=this._createInput(this.options.text,"search-input"),this._tooltip=this._createTooltip("search-tooltip"),this._cancel=this._createCancel(this.options.textCancel,"search-cancel"),this._button=this._createButton(this.options.text,"search-button"),this._alert=this._createAlert("search-alert"),this.options.collapsed===!1&&this.expand();if(this.options.circleLocation||this.options.markerLocation)this._markerLoc=new t([0,0],{marker:this.options.markerLocation});return this.setLayer(this._layer),e.on({resize:this._handleAutoresize},this),this._container},addTo:function(e){return this.options.wrapper?(this._container=this.onAdd(e),this._wrapper=L.DomUtil.get(this.options.wrapper),this._wrapper.style.position="relative",this._wrapper.appendChild(this._container)):L.Control.prototype.addTo.call(this,e),this},onRemove:function(e){this._recordsCache={}},_getPath:function(e,t){var n=t.split("."),r=n.pop(),i=n.length,s=n[0],o=1;if(i>0)while((e=e[s])&&o<i)s=n[o++];if(e)return e[r]},setLayer:function(e){return this._layer=e,this._layer.addTo(this._map),this._markerLoc&&this._layer.addLayer(this._markerLoc),this},showAlert:function(e){e=e||this.options.textErr,this._alert.style.display="block",this._alert.innerHTML=e,clearTimeout(this.timerAlert);var t=this;return this.timerAlert=setTimeout(function(){t.hideAlert()},this.options.autoCollapseTime),this},hideAlert:function(){return this._alert.style.display="none",this},cancel:function(){return this._input.value="",this._handleKeypress({keyCode:8}),this._input.size=this._inputMinSize,this._input.focus(),this._cancel.style.display="none",this},expand:function(){return this._input.style.display="block",L.DomUtil.addClass(this._container,"search-exp"),this._input.focus(),this._map.on("dragstart click",this.collapse,this),this},collapse:function(){return this._hideTooltip(),this.cancel(),this._alert.style.display="none",this._input.blur(),this.options.collapsed&&(this._input.style.display="none",this._cancel.style.display="none",L.DomUtil.removeClass(this._container,"search-exp"),this._map.off("dragstart click",this.collapse,this)),this.fire("search_collapsed"),this},collapseDelayed:function(){if(!this.options.autoCollapse)return this;var e=this;return clearTimeout(this.timerCollapse),this.timerCollapse=setTimeout(function(){e.collapse()},this.options.autoCollapseTime),this},collapseDelayedStop:function(){return clearTimeout(this.timerCollapse),this},_createAlert:function(e){var t=L.DomUtil.create("div",e,this._container);return t.style.display="none",L.DomEvent.on(t,"click",L.DomEvent.stop,this).on(t,"click",this.hideAlert,this),t},_createInput:function(e,t){var n=L.DomUtil.create("input",t,this._container);return n.type="text",n.size=this._inputMinSize,n.value="",n.autocomplete="off",n.placeholder=e,n.style.display="none",L.DomEvent.disableClickPropagation(n).on(n,"keyup",this._handleKeypress,this).on(n,"keydown",this._handleAutoresize,this).on(n,"blur",this.collapseDelayed,this).on(n,"focus",this.collapseDelayedStop,this),n},_createCancel:function(e,t){var n=L.DomUtil.create("a",t,this._container);return n.href="#",n.title=e,n.style.display="none",n.innerHTML="<span>&otimes;</span>",L.DomEvent.on(n,"click",L.DomEvent.stop,this).on(n,"click",this.cancel,this),n},_createButton:function(e,t){var n=L.DomUtil.create("a",t,this._container);return n.href="#",n.title=e,L.DomEvent.on(n,"click",L.DomEvent.stop,this).on(n,"click",this._handleSubmit,this).on(n,"focus",this.collapseDelayedStop,this).on(n,"blur",this.collapseDelayed,this),n},_createTooltip:function(e){var t=L.DomUtil.create("div",e,this._container);t.style.display="none";var n=this;return L.DomEvent.disableClickPropagation(t).on(t,"blur",this.collapseDelayed,this).on(t,"mousewheel",function(e){n.collapseDelayedStop(),L.DomEvent.stopPropagation(e)},this).on(t,"mouseover",function(e){n.collapseDelayedStop()},this),t},_createTip:function(e,t){var n;if(this.options.callTip){n=this.options.callTip(e,t);if(typeof n=="string"){var r=L.DomUtil.create("div");r.innerHTML=n,n=r.firstChild}}else n=L.DomUtil.create("a",""),n.href="#",n.innerHTML=e;return L.DomUtil.addClass(n,"search-tip"),n._text=e,L.DomEvent.disableClickPropagation(n).on(n,"click",L.DomEvent.stop,this).on(n,"click",function(t){this._input.value=e,this._handleAutoresize(),this._input.focus(),this._hideTooltip(),this.options.tipAutoSubmit&&this._handleSubmit()},this),n},_filterRecords:function(e){var t=new RegExp("^[.]$|[[]|()*]","g"),n,r,i={};e=e.replace(t,""),n=this.options.initial?"^":"",r=new RegExp(n+e,"i");for(var s in this._recordsCache)r.test(s)&&(i[s]=this._recordsCache[s]);return i},showTooltip:function(){var e,t;this._countertips=0,this.options.layer?e=this._filterRecords(this._input.value):e=this._recordsCache,this._tooltip.innerHTML="",this._tooltip.currentSelection=-1;for(var n in e){if(++this._countertips==this.options.tooltipLimit)break;t=this._createTip(n,e[n]),this._tooltip.appendChild(t)}return this._countertips>0?(this._tooltip.style.display="block",this._autoTypeTmp&&this._autoType(),this._autoTypeTmp=this.options.autoType):this._hideTooltip(),this._tooltip.scrollTop=0,this._countertips},_hideTooltip:function(){return this._tooltip.style.display="none",this._tooltip.innerHTML="",0},_defaultFilterJSON:function(e){var t={},n,r=this.options.propertyName,i=this.options.propertyLoc;if(L.Util.isArray(i))for(n in e)t[this._getPath(e[n],r)]=L.latLng(e[n][i[0]],e[n][i[1]]);else for(n in e)t[this._getPath(e[n],r)]=L.latLng(this._getPath(e[n],i));return t},_recordsFromJsonp:function(e,t){var n=this;L.Control.Search.callJsonp=function(e){var r=n._filterJSON(e);t(r)};var r=L.DomUtil.create("script","search-jsonp",document.getElementsByTagName("body")[0]),i=L.Util.template(this.options.url+"&"+this.options.jsonpParam+"=L.Control.Search.callJsonp",{s:e});return r.type="text/javascript",r.src=i,this},_recordsFromAjax:function(e,t){window.XMLHttpRequest===undefined&&(window.XMLHttpRequest=function(){try{return new ActiveXObject("Microsoft.XMLHTTP.6.0")}catch(e){try{return new ActiveXObject("Microsoft.XMLHTTP.3.0")}catch(t){throw new Error("XMLHttpRequest is not supported")}}});var n=new XMLHttpRequest,r=L.Util.template(this.options.url,{s:e}),i={};n.open("GET",r);var s=this;return n.onreadystatechange=function(){if(n.readyState===4&&n.status===200){i=JSON.parse(n.responseText);var e=s._filterJSON(i);t(e)}},n.send(),this},_recordsFromLayer:function(){var e=this,n={},r=this.options.propertyName,i;return this._layer.eachLayer(function(s){if(s instanceof t)return;s instanceof L.Marker?e._getPath(s.options,r)?(i=s.getLatLng(),i.layer=s,n[e._getPath(s.options,r)]=i):e._getPath(s.feature.properties,r)?(i=s.getLatLng(),i.layer=s,n[e._getPath(s.feature.properties,r)]=i):console.log("propertyName '"+r+"' not found in marker",s):s.hasOwnProperty("feature")&&(s.feature.properties.hasOwnProperty(r)?(i=s.getBounds().getCenter(),i.layer=s,n[s.feature.properties[r]]=i):console.log("propertyName '"+r+"' not found in feature",s))},this),n},_autoType:function(){var e=this._input.value.length,t=this._tooltip.firstChild._text,n=t.length;if(t.indexOf(this._input.value)===0){this._input.value=t,this._handleAutoresize();if(this._input.createTextRange){var r=this._input.createTextRange();r.collapse(!0),r.moveStart("character",e),r.moveEnd("character",n),r.select()}else this._input.setSelectionRange?this._input.setSelectionRange(e,n):this._input.selectionStart&&(this._input.selectionStart=e,this._input.selectionEnd=n)}},_hideAutoType:function(){var e;if((e=this._input.selection)&&e.empty)e.empty();else if(this._input.createTextRange){e=this._input.createTextRange(),e.collapse(!0);var t=this._input.value.length;e.moveStart("character",t),e.moveEnd("character",t),e.select()}else this._input.getSelection&&this._input.getSelection().removeAllRanges(),this._input.selectionStart=this._input.selectionEnd},_handleKeypress:function(e){switch(e.keyCode){case 27:this.collapse();break;case 13:this._countertips==1&&this._handleArrowSelect(1),this._handleSubmit();break;case 38:this._handleArrowSelect(-1);break;case 40:this._handleArrowSelect(1);break;case 37:case 39:case 16:case 17:break;case 8:case 46:this._autoTypeTmp=!1;break;default:this._input.value.length?this._cancel.style.display="block":this._cancel.style.display="none";if(this._input.value.length>=this.options.minLength){var t=this;clearTimeout(this.timerKeypress),this.timerKeypress=setTimeout(function(){t._fillRecordsCache()},this.options.delayType)}else this._hideTooltip()}},_fillRecordsCache:function(){var e=this._input.value,t;L.DomUtil.addClass(this._container,"search-load"),this.options.callData?(t=this,this.options.callData(e,function(e){t._recordsCache=t._filterJSON(e),t.showTooltip(),L.DomUtil.removeClass(t._container,"search-load")})):this.options.url?this.options.jsonpParam?(t=this,this._recordsFromJsonp(e,function(e){t._recordsCache=e,t.showTooltip(),L.DomUtil.removeClass(t._container,"search-load")})):(t=this,this._recordsFromAjax(e,function(e){t._recordsCache=e,t.showTooltip(),L.DomUtil.removeClass(t._container,"search-load")})):this.options.layer&&(this._recordsCache=this._recordsFromLayer(),this.showTooltip(),L.DomUtil.removeClass(this._container,"search-load"))},_handleAutoresize:function(){this._input.style.maxWidth!=this._map._container.offsetWidth&&(this._input.style.maxWidth=L.DomUtil.getStyle(this._map._container,"width")),this.options.autoResize&&this._container.offsetWidth+45<this._map._container.offsetWidth&&(this._input.size=this._input.value.length<this._inputMinSize?this._inputMinSize:this._input.value.length)},_handleArrowSelect:function(e){var t=this._tooltip.hasChildNodes()?this._tooltip.childNodes:[];for(i=0;i<t.length;i++)L.DomUtil.removeClass(t[i],"search-tip-select");if(e==1&&this._tooltip.currentSelection>=t.length-1)L.DomUtil.addClass(t[this._tooltip.currentSelection],"search-tip-select");else if(e==-1&&this._tooltip.currentSelection<=0)this._tooltip.currentSelection=-1;else if(this._tooltip.style.display!="none"){this._tooltip.currentSelection+=e,L.DomUtil.addClass(t[this._tooltip.currentSelection],"search-tip-select"),this._input.value=t[this._tooltip.currentSelection]._text;var n=t[this._tooltip.currentSelection].offsetTop;n+t[this._tooltip.currentSelection].clientHeight>=this._tooltip.scrollTop+this._tooltip.clientHeight?this._tooltip.scrollTop=n-this._tooltip.clientHeight+t[this._tooltip.currentSelection].clientHeight:n<=this._tooltip.scrollTop&&(this._tooltip.scrollTop=n)}},_handleSubmit:function(){this._hideAutoType(),this.hideAlert(),this._hideTooltip();if(this._input.style.display=="none")this.expand();else if(this._input.value==="")this.collapse();else{var e=this._getLocation(this._input.value);e===!1?this.showAlert():(this.showLocation(e,this._input.value),this.fire("search_locationfound",{latlng:e,text:this._input.value,layer:e.layer?e.layer:null}))}},_getLocation:function(e){return this._recordsCache.hasOwnProperty(e)?this._recordsCache[e]:!1},showLocation:function(e,t){return this.options.zoom?this._map.setView(e,this.options.zoom):this._map.panTo(e),this._markerLoc&&(this._markerLoc.setLatLng(e),this._markerLoc.setTitle(t),this._markerLoc.show(),this.options.animateLocation&&this._markerLoc.animate()),this.options.autoCollapse&&this.collapse(),this}});var e=new L.icon({iconUrl:"../img/red_18x18.png",iconSize:[12,12]}),t=L.Marker.extend({includes:L.Mixin.Events,options:{icon:e,radius:10,weight:3,color:"#e03",stroke:!0,fill:!1,title:"",marker:!1},initialize:function(e,t){L.setOptions(this,t),L.Marker.prototype.initialize.call(this,e,t),this._circleLoc=new L.CircleMarker(e,this.options)},onAdd:function(e){L.Marker.prototype.onAdd.call(this,e),e.addLayer(this._circleLoc),this.hide()},onRemove:function(e){L.Marker.prototype.onRemove.call(this,e),e.removeLayer(this._circleLoc)},setLatLng:function(e){return L.Marker.prototype.setLatLng.call(this,e),this._circleLoc.setLatLng(e),this},setTitle:function(e){return e=e||"",this.options.title=e,this._icon&&(this._icon.title=e),this},show:function(){return this.options.marker&&(this._icon&&(this._icon.style.display="block"),this._shadow&&(this._shadow.style.display="block")),this._circleLoc&&this._circleLoc.setStyle({fill:this.options.fill,stroke:this.options.stroke}),this},hide:function(){return this._icon&&(this._icon.style.display="none"),this._shadow&&(this._shadow.style.display="none"),this._circleLoc&&this._circleLoc.setStyle({fill:!1,stroke:!1}),this},animate:function(){var e=this._circleLoc,t=200,n=10,r=parseInt(e._radius/n),i=this.options.radius,s=e._radius*2.5,o=0;return e._timerAnimLoc=setInterval(function(){o+=.5,r+=o,s-=r,e.setRadius(s),s<i&&(clearInterval(e._timerAnimLoc),e.setRadius(i))},t),this}});L.Map.addInitHook(function(){this.options.searchControl&&(this.searchControl=L.control.search(this.options.searchControl),this.addControl(this.searchControl))}),L.control.search=function(e){return new L.Control.Search(e)}}).call(this);